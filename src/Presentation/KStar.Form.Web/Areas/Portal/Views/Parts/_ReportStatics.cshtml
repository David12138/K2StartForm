<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>BPM系统</title>
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <link href="~/Scripts/element/2.8.2/theme-chalk/index.css" rel="stylesheet" />
    <script src="~/Scripts/vue/2.6.10/vue.js"></script>
    <script src="~/Scripts/element/2.8.2/index.js"></script>
    <script src="~/Scripts/axios/0.19.0/axios.js"></script>
    <script src="~/Scripts/axios/0.19.0/axios.js"></script>
    @* <link rel="stylesheet" href="~/Content/portal/icon.css"> *@
    <link rel="stylesheet" href="~/Content/portal/iconfont.css">
    <script src="~/Scripts/IE-promise.js"></script>
    <script src="~/Scripts/portal/echarts.min.js"></script>
    <script src="~/Scripts/portal/config.js"></script>
    <script src="~/Scripts/portal/api.js"></script>
    <script src="~/Scripts/portal/util.js?v=1.0.0"></script>
    <script src="~/Scripts/jquery-3.4.1.js"></script>
    <script src="~/Content/portal/images/jquery.nicescroll.min.js"></script>
    <script src="~/Scripts/moment-with-locales.min.js"></script>
    <script src="~/Scripts/lodash/lodash.min.js"></script>
</head>
<body>
    <div id="app">
        <div class="home-left home" style="width:100%">
            <el-tabs v-model="activeNameLeft">
                <el-tab-pane name="first" class="home-el-tab-pane">
                    <span slot="label">&nbsp;&nbsp;报表&nbsp;&nbsp;</span>
                    <div class="agingreport" style="height:100%" v-loading="agingreportLoading">
                        <div style="padding: 10px 30px 0 30px; height: 100%;background: #f0f2f5;box-sizing: border-box;">
                            <el-row style="margin-top: 0">
                                <el-form :inline="true" :model="agingreportForm">
                                    <el-form-item label="公司：">
                                        <el-cascader v-model="agingreportForm.compName" :props="{value: 'OrgId', label: 'OrgName',children: 'Child'}" :options="reportOrgData" v-on:change="handleChange" size="small" style="width: 350px"></el-cascader>
                                    </el-form-item>
                                    <el-form-item label="月度：">
                                        <el-date-picker v-model="agingreportForm.region" value-format="yyyy-MM" :picker-options="pickerOptions" type="month" placeholder="选择月" size="small" :clearable="false" v-on:change="handleChangeDate"></el-date-picker>
                                    </el-form-item>
                                    <span style="float:right;line-height:40px;font-size:14px" class="info">截至统计时间：{{getFormatDates(userApproveReport.userBaseData.EndStatisticDate)}}</span>
                                </el-form>

                            </el-row>
                            <el-row class="dataList">
                                <el-col v-if="isShowDiv('com')">
                                    <el-row v-if="!(userApproveReport.userBaseData.UserType == 1 &&userApproveReport.userBaseData.UserRandType == 1)">
                                        <el-row class="top list-one">
                                            <el-row class="info mr-b-10">本公司及时率</el-row>
                                            <el-row class="text-align-center fs-23 font-theme-color">{{userApproveReport.orgData.CompanyTimely}}%</el-row>
                                            <el-row class="ellipsis" :title="'本公司在全集团排名：第'+userApproveReport.orgData.CompanyTimelySort+'名'">本公司在全集团排名：第<strong class="blue" v-text="userApproveReport.orgData.CompanyTimelySort"></strong>名</el-row>
                                        </el-row>
                                        <el-row class="buttom font-theme-color">预警：及时率有被扣分风险！</el-row>
                                    </el-row>
                                    <el-row v-else>
                                        <el-row class="top list-one">
                                            <el-row class="info mr-b-10">集团平均及时率</el-row>
                                            <el-row class="text-align-center fs-23 font-theme-color" style="height: 28px">{{userApproveReport.groupManagerData.TotalTimely}}%</el-row>
                                            <el-row class="ellipsis" :title="'总部平均及时率：'+userApproveReport.groupManagerData.GroupTimely+'%'">总部平均及时率：{{ userApproveReport.groupManagerData.GroupTimely }}%</el-row>
                                            <el-row class="ellipsis" :title="'下属公司平均及时率：'+userApproveReport.groupManagerData.CompTimely+'%'">下属公司平均及时率：{{ userApproveReport.groupManagerData.CompTimely }}%</el-row>
                                        </el-row>
                                        <el-row class="buttom">集团总部及下属公司的平均及时率</el-row>
                                    </el-row>
                                </el-col>

                                <div style="height:1px; width:100%" v-if="!isShowDiv('dep')"></div>

                                <el-col v-if="isShowDiv('com')">
                                    <el-row v-if="!(userApproveReport.userBaseData.UserType == 1 &&userApproveReport.userBaseData.UserRandType == 1)">
                                        <el-row class="top">
                                            <el-row class="info mr-b-10">本公司审批平均耗时</el-row>
                                            <el-row class="fs-23 height-38">{{userApproveReport.orgData.CompanyApproveTime}}h</el-row>
                                            <el-row class="chart">
                                                <div id="companyApproveTimeList" style="height: 100%"></div>
                                            </el-row>
                                        </el-row>
                                        <el-row class="buttom" :title="'本公司在全集团排名：第'+userApproveReport.orgData.CompanyApproveTimeSort+'名'">本公司在全集团排名：第<strong class="blue" v-text="userApproveReport.orgData.CompanyApproveTimeSort"></strong>名</el-row>
                                    </el-row>
                                    <el-row v-else>
                                        <el-row class="top list-one">
                                            <el-row class="info mr-b-10">集团平均耗时</el-row>
                                            <el-row class="fs-23" style="height: 28px">{{userApproveReport.groupManagerData.TotalApproveTimeAvg}}h</el-row>
                                            <el-row class="ellipsis" :title="'总部平均耗时：'+userApproveReport.groupManagerData.GroupApproveTimeAvg+'h'">总部平均耗时：{{ userApproveReport.groupManagerData.GroupApproveTimeAvg }}h</el-row>
                                            <el-row class="ellipsis" :title="'下属公司平均耗时：'+userApproveReport.groupManagerData.CompApproveTimeAvg+'h'">下属公司平均耗时：{{ userApproveReport.groupManagerData.CompApproveTimeAvg }}h</el-row>
                                        </el-row>
                                        <el-row class="buttom">集团总部及下属公司的平均耗时</el-row>
                                    </el-row>
                                </el-col>

                                <div style="height:1px; width:100%" v-if="!isShowDiv('dep')"></div>

                                <el-col v-if="isShowDiv('com')" class="overflow-hidden">
                                    <el-row v-if="!(userApproveReport.userBaseData.UserType == 1 &&userApproveReport.userBaseData.UserRandType == 1)">
                                        <el-row class="top">
                                            <el-row class="info mr-b-10">本公司被回退数量：{{userApproveReport.orgData.CompanyReturnTimes}}</el-row>
                                            <div class="scroll-inline">
                                                <el-row class="scroll-inline-sub" id="comReturn">
                                                    <el-col v-for="(item, index) in userApproveReport.orgData.CompanyReturnTypeList" v-if="item.Score !== '0'" class="ellipsis" :title="item.Name +':'+ item.Score">{{item.Name}}：{{item.Score}}</el-col>
                                                </el-row>
                                            </div>

                                        </el-row>
                                        <el-row class="buttom" :title="'本公司在全集团排名：第'+userApproveReport.orgData.CompanyReturnTimesSort+'名'">本公司在全集团排名：第<strong class="blue" v-text="userApproveReport.orgData.CompanyReturnTimesSort"></strong>名</el-row>
                                    </el-row>
                                    <el-row v-else>
                                        <el-row class="top">
                                            <el-row class="info mr-b-10">本部门被回退数量：{{userApproveReport.orgData.DepReturnTimes}}</el-row>
                                            <div class="scroll-inline">
                                                <el-row class="scroll-inline-sub" id="depReturn">
                                                    <el-col v-for="(item, index) in userApproveReport.orgData.DepReturnTypeList" v-if="item.Score !== '0'" class="ellipsis" :title="item.Name +':'+ item.Score">{{item.Name}}：{{item.Score}}</el-col>
                                                </el-row>
                                            </div>
                                        </el-row>
                                        <el-row class="buttom" :title="'本部门在公司排名：第'+userApproveReport.orgData.DepReturnTimesSort+'名'">本部门在公司排名：第<strong class="blue" v-text="userApproveReport.orgData.DepReturnTimesSort"></strong>名</el-row>
                                    </el-row>
                                </el-col>

                                <el-col v-if="isShowDiv('dep')">
                                    <el-row class="top list-one">
                                        <el-row class="info mr-b-10">本部门及时率</el-row>
                                        <el-row class="text-align-center fs-23 green">{{userApproveReport.orgData.DepTimely}}% </el-row>
                                        <el-row class="ellipsis" :title="'本部门在公司排名：第'+userApproveReport.orgData.DepTimelySort+'名'">本部门在公司排名：第<strong class="blue" v-text="userApproveReport.orgData.DepTimelySort"></strong>名</el-row>
                                    </el-row>
                                    <el-row class="buttom font-theme-color">预警：及时率有被扣分风险！</el-row>
                                </el-col>

                                <div style="height:1px; width:100%" v-if="!isShowDiv('com')"></div>

                                <el-col v-if="isShowDiv('dep')">
                                    <el-row class="top">
                                        <el-row class="info mr-b-10">本部门审批平均耗时</el-row>
                                        <el-row class="fs-23 height-38">{{userApproveReport.orgData.DepApproveTime}}h</el-row>
                                        <el-row class="chart">
                                            <div id="depApproveTimeList" style="height:100%"></div>
                                        </el-row>
                                    </el-row>
                                    <el-row class="buttom" :title="'本部门在公司排名：第'+userApproveReport.orgData.DepApproveTimeSort+'名'">本部门在公司排名：第<strong class="blue" v-text="userApproveReport.orgData.DepApproveTimeSort"></strong>名</el-row>
                                </el-col>

                                <div style="height:1px; width:100%" v-if="!isShowDiv('com')"></div>

                                <el-col class="overflow-hidden" v-if="isShowDiv('dep')">
                                    <el-row class="top">
                                        <el-row class="info mr-b-10">本部门被回退数量：{{userApproveReport.orgData.DepReturnTimes}}</el-row>
                                        <div class="scroll-inline">
                                            <el-row class="scroll-inline-sub" id="depReturn">
                                                <el-col v-for="(item, index) in userApproveReport.orgData.DepReturnTypeList" v-if="item.Score !== '0'" class="ellipsis" :title="item.Name +':'+ item.Score">{{item.Name}}：{{item.Score}}</el-col>
                                            </el-row>
                                        </div>
                                    </el-row>
                                    <el-row class="buttom" :title="'本公司在全集团排名：第'+userApproveReport.orgData.DepReturnTimesSort+'名'">本公司在全集团排名：第<strong class="blue" v-text="userApproveReport.orgData.DepReturnTimesSort"></strong>名</el-row>
                                </el-col>
                            </el-row>
                            <el-row style="padding: 0 20px;background-color: #fff;margin-top: 20px;">
                                <el-row style="border-bottom: 1px solid #e8e8e8;">
                                    <el-col :span="18" style="line-height: 49px;font-size: 14px">
                                        <div style="float:left;color: rgba(0, 0, 0, 0.85);">个人维度指标</div>
                                        <div style="float:right;border-right: 1px solid #e8e8e8;padding-right: 50px;color:#505050">
                                            <span class="select-li" :class="agingreportForm.curTime == 'month' ? 'active' : ''" v-on:click="changeMonth('month')">本月</span>
                                            <span class="select-li" :class="agingreportForm.curTime == 'quarter' ? 'active' : ''" v-on:click="changeMonth('quarter')">本季度</span>
                                            <span class="select-li" :class="agingreportForm.curTime == 'year' ? 'active' : ''" v-on:click="changeMonth('year')">全年</span>
                                        </div>
                                    </el-col>
                                    <el-col :span="6" style="line-height:49px;padding-left: 20px">
                                        <el-date-picker v-model="agingreportForm.timerange" type="daterange" :clearable="false" range-separator="~" start-placeholder="开始日期" end-placeholder="结束日期" size="small" value-format="yyyy-MM-dd" v-on:change="changeTime"></el-date-picker>
                                    </el-col>
                                </el-row>
                            </el-row>
                            <div style="height: calc(100% - 264px);background-color: #fff;" id="perChart">
                                <el-row style="height:100%;min-height: 400px;width:99.9%" class="perChartsDiv">
                                    <div id="personalDetails" style="height: 100%;width:100%" :style="{backgroundImage: 'url(' + backgroundImage + ')'}"></div>
                                </el-row>
                            </div>
                        </div>
                    </div>

                </el-tab-pane>
            </el-tabs>
        </div>
    </div>

</body>
</html>
<script>
    vmInstance = new Vue({
        el: '#app',
        data: function () {
            return {

                form: {}, // 表单数据
                btnLoading: false,
                activeNameLeft: 'first',
                activeNameRight: 'first',
                userInfoName: '',
                elTabsOneLoading: true,
                elTabsTwoLoading: true,
                timer: null,
                activityNumLimit: 0,

                agingreportForm: {
                    curTime: 'month',
                    compName: [],
                    region: '',
                    timerange: []
                },
                companyApproveTimeListChart: null,
                depApproveTimeListChart: null,
                personalDetailsChart: null,
                reportOrgData: [],
                userApproveReport: {
                    userBaseData: {},
                    orgData: {},
                    userData: {},
                    groupManagerData: {}
                },
                agingreportLoading: false,
                isShowRight: true,
                dialogResult: '',
                dialogResultList: [],
                backgroundImage: '',
                pickerOptions: {
                    disabledDate: function (time) {
                        return time.getTime() > Date.now();
                    },
                }
            }
        },

        computed: {
            isShowDiv: function () {
                return function (val) {
                    if (val == 'com') {
                        return !(this.userApproveReport.userBaseData.UserType == 1 && this.userApproveReport.userBaseData.UserRandType != 1)
                    } else if (val == 'dep') {
                        return this.userApproveReport.userBaseData.UserRandType != 1
                    }
                }
            }
        },

        mounted: function () {
            this.getReportOrgData()
        },
        methods: {
            // 获取当前用户信息
            getUserInfo: function (val) {
                var that = this
                GetUserInfo({
                    userAccount: val.ApplicantAccount,
                    FormId: val.FormId
                }).then(function (res) {
                    that.userInfo = res.data.data
                })
            },
            // 日期转换
            getFormatDate: function (date) {
                if (date) { return moment(date).format('YYYY-MM-DD HH:mm:ss') }
            },
            getFormatDates: function (date) {
                if (date) { return moment(date).format('YYYY-MM-DD') }
            },
            getReset: function () {
                this.btnLoading = false
                this.dialogVisible = false
                this.dialogForm = {}
                getKStarWorklistCount($this)
            },
            handleClick: function () {
                debugger
                console.log(this.activeNameLeft)
                if (this.activeNameLeft == 'first') {
                    var that = this
                    this.isShowRight = false
                    // 第一次进需要去请求数据
                    console.log(this.userApproveReport)
                    console.log(this.userApproveReport.userBaseData)
                    console.log(this.userApproveReport.userBaseData.EndStatisticDate)
                    if (typeof this.userApproveReport.userBaseData.EndStatisticDate == 'undefined') {
                        this.agingreportLoading = true
                        that.agingreportForm.timerange = that.getCurTime('month')
                        that.agingreportForm.region = that.agingreportForm.timerange[0].split('-').splice(0, 2).join('-')
                        that.resetChart({
                            companyId: that.agingreportForm.compName[0],
                            depId: that.agingreportForm.compName[1],
                            orgStart: that.agingreportForm.timerange[0],
                            orgEnd: that.agingreportForm.timerange[1],
                            userStart: that.agingreportForm.timerange[0],
                            userEnd: that.agingreportForm.timerange[1]
                        })
                    } else {
                        // 只需重新渲染图表即可
                        this.newSetChart()
                    }

                    window.addEventListener('resize', this.handleResetChar)
                } else {
                    this.isShowRight = true
                    $(".home-left #perChart").getNiceScroll().remove();
                    $(".home-left #comReturn").getNiceScroll().remove();
                    $(".home-left #depReturn").getNiceScroll().remove();
                    window.removeEventListener('resize', this.handleResetChar)
                    this.companyApproveTimeListChart = null
                    this.depApproveTimeListChart = null
                    this.personalDetailsChart = null

                }
            },
            handleResetChar: function () {
                if (this.companyApproveTimeListChart) {
                    this.companyApproveTimeListChart.resize()
                }
                if (this.depApproveTimeListChart) {
                    this.depApproveTimeListChart.resize()

                }
                if (this.personalDetailsChart) {
                    this.personalDetailsChart.resize()
                }
            },
            // 获取部门数据
            getReportOrgData: function () {
                var that = this
                GetReportOrgTree().then(function (res) {
                    if (res.data.data.length) {
                        that.reportOrgData = res.data.data
                        that.agingreportForm.compName = [res.data.data[0].OrgId, res.data.data[0].Child[0].OrgId]
                        console.log('get org success')

                        that.handleClick()
                    }
                })
            },
            // 改变数据渲染图表
            resetChart: function (form, type) {
                var that = this
                that.agingreportLoading = true
                GetUserApproveReport(form).then(function (res) {
                    that.agingreportLoading = false
                    switch (type) {
                        case 1:
                            // 只重新渲染个人维度指标
                            that.userApproveReport.userData = res.data.data.userData
                            break;
                        case 2:
                            // 选渲染
                            that.userApproveReport.groupManagerData = res.data.data.groupManagerData
                            that.userApproveReport.orgData = res.data.data.orgData
                            break;
                        default:
                            that.userApproveReport = res.data.data

                    }

                    that.$nextTick(function () {
                        that.newSetChart(type)
                    })
                })
            },
            newSetChart: function (type) {
                // 1：集团总部（不需要显示公司模块
                if (document.getElementById('companyApproveTimeList') && type !== 1) {
                    this.getCompanyApproveTimeListChart(this.userApproveReport.orgData.CompanyApproveTimeList)
                }
                if (document.getElementById('depApproveTimeList') && type != 1) {
                    this.getDepApproveTimeList(this.userApproveReport.orgData.DepApproveTimeList)
                }
                if (document.getElementById('personalDetails') && type != 2) {
                    this.getPersonalDetails(this.userApproveReport.userData)
                }

                if (document.getElementById('comReturn') && type != 1) {
                    $(".home-left #comReturn").getNiceScroll().remove();
                    $(".home-left #comReturn").niceScroll({ cursoropacitymin: 0.2, cursoropacitymax: 0.2, cursorcolor: "#000" });
                }
                if (document.getElementById('comReturn') && type != 1) {
                    $(".home-left #depReturn").getNiceScroll().remove();
                    $(".home-left #depReturn").niceScroll({ cursoropacitymin: 0.2, cursoropacitymax: 0.2, cursorcolor: "#000" });
                }
            },
            // 本公司审批平均耗时
            getCompanyApproveTimeListChart: function (val) {
                if (!this.companyApproveTimeListChart) {
                    this.companyApproveTimeListChart = echarts.init(document.getElementById('companyApproveTimeList'))
                }
                var companyApproveTimeListChart = this.companyApproveTimeListChart
                var aAxisData = []
                var seriesData = []
                if (val) {
                    val.map(function (item) {
                        aAxisData.push(item.Name)
                        seriesData.push(item.Score)
                    })
                }

                var option = {
                    color: ['#3398DB'],
                    tooltip: {
                        //confine: true,
                        position: function (point, params, dom, rect, size) {
                            return { left: point[0], top: -30 };
                        },
                        axisPointer: {
                            type: ''
                        }
                    },
                    grid: {
                        top: 0,
                        left: 0,
                        right: 0,
                        bottom: 10
                    },
                    dataZoom: [
                        {
                            type: 'slider',
                            show: true,
                            realtime: true,
                            start: 0,
                            end: 30,
                            height: 8,
                            bottom: 0,
                            showDetail: false,
                            zoomLock: true
                        },
                        {
                            type: 'inside',
                            realtime: true,
                            start: 0,
                            end: 30,
                        }
                    ],
                    xAxis: [
                        {
                            //type: 'category',
                            data: aAxisData,
                            show: false
                        }
                    ],
                    yAxis: [
                        {
                            type: 'value',
                            show: false
                        }
                    ],
                    series: [
                        {
                            // name: ' ',
                            type: 'bar',
                            data: seriesData,
                            barMinHeight: 3,
                        }
                    ],
                };
                companyApproveTimeListChart.setOption(option);
                var that = this
                this.$nextTick(function () {
                    that.companyApproveTimeListChart.resize()
                })
            },
            // 本部门审批平均耗时
            getDepApproveTimeList: function (val) {
                if (!this.depApproveTimeListChart) {
                    this.depApproveTimeListChart = echarts.init(document.getElementById('depApproveTimeList'))
                }
                var depApproveTimeListChart = this.depApproveTimeListChart
                var aAxisData = []
                var seriesData = []
                if (val) {
                    val.map(function (item) {
                        aAxisData.push(item.Name)
                        seriesData.push(item.Score)
                    })
                }
                var option = {
                    color: ['#3398DB'],
                    tooltip: {
                        //confine: true,
                        position: function (point, params, dom, rect, size) {
                            return { left: point[0], top: -30 };
                        },
                        axisPointer: {
                            type: ''
                        }
                    },
                    grid: {
                        top: 0,
                        left: 0,
                        right: 0,
                        bottom: 10
                    },
                    dataZoom: [
                        {
                            type: 'slider',
                            show: true,
                            realtime: true,
                            start: 0,
                            end: 30,
                            height: 8,
                            bottom: 0,
                            showDetail: false,
                            zoomLock: true
                        },
                        {
                            type: 'inside',
                            realtime: true,
                            start: 0,
                            end: 30,
                        }
                    ],
                    xAxis: [
                        {
                            //type: 'category',
                            data: aAxisData,
                            show: false
                        }
                    ],
                    yAxis: [
                        {
                            type: 'value',
                            show: false
                        }
                    ],
                    series: [
                        {
                            // name: ' ',
                            type: 'bar',
                            data: seriesData,
                            barMinHeight: 3,
                        }
                    ],
                };
                depApproveTimeListChart.setOption(option);
                var that = this
                this.$nextTick(function () {
                    that.depApproveTimeListChart.resize()
                })
            },
            // 个人维度指标
            getPersonalDetails: function (val) {
                if (!this.personalDetailsChart) {
                    this.personalDetailsChart = echarts.init(document.getElementById('personalDetails'))
                }
                var personalDetailsChart = this.personalDetailsChart
                this.backgroundImage = sessionStorage.getItem('imgUrl') == '../../Content/portal/images/userLogo.png' ? '' : sessionStorage.getItem('imgUrl')

                var data = []
                if (this.userApproveReport.userBaseData.UserType == 2 && this.userApproveReport.userBaseData.UserRandType == 1) {
                    // 分公司高管
                    data = [
                        { value: 1, name: '审批操作', html: '{pieTitle|审批操作}\n{li|已审批节点数：' + val.UserApproveTimes + '}\n{li|沟通次数：' + val.UserCommunicateTimes + '}\n{li|指派次数：' + val.UserRedirectTimes + '}' },
                        { value: 1, name: '页面浏览', html: '{pieTitle|页面浏览}\n{li|审批浏览平均时长：' + val.UserViewAverage + 'min}\n{li|本部门排名：' + val.UserViewAverageSort + ' / ' + val.DepUserCount + '}' },
                        { value: 1, name: '附件审核', html: '{pieTitle|附件审核}\n{li|附件打开次数：' + val.AttachTimes + '次}\n{li|附件审核比例：' + val.AttachPercent + '%}\n{li|本部门排名：' + val.AttachTimesSort + ' / ' + val.DepUserCount + '}' },
                        { value: 1, name: '审批耗时', html: '{pieTitle|审批耗时}\n{li|审批总耗时：' + val.UserApproveTimeCount + 'h}\n{li|平均节点耗时：' + val.UserApproveTimeAverage + 'h}\n{li|本部门排名：' + val.UserApproveTimeSort + ' / ' + val.DepUserCount + '}' },
                        { value: 1, name: '严重超时', html: '{pieTitle|严重超时}\n{num|' + val.OverTimeTimes + '}\n{hr|}\n{li|即将超时流程：' + val.Pre_OverTimeTimes + '}' },
                        { value: 1, name: '审批及时率', html: '{pieTitle|审批及时率}\n{num|' + val.UserTimely + '%}\n{hr|}\n{li|分公司负责人及时率}\n{li|排名：' + val.ManagerCount + ' / ' + val.ManagerTimelySort + '}' }
                    ]
                } else if ((this.userApproveReport.userBaseData.UserType == 1 && this.userApproveReport.userBaseData.UserRandType == 1) || (this.userApproveReport.userBaseData.UserType == 1 && this.userApproveReport.userBaseData.UserRandType == 2)) {
                    // 集团高管
                    data = [
                        { value: 1, name: '审批操作', html: '{pieTitle|审批操作}\n{li|已审批节点数：' + val.UserApproveTimes + '}\n{li|沟通次数：' + val.UserCommunicateTimes + '}\n{li|指派次数：' + val.UserRedirectTimes + '}' },
                        { value: 1, name: '页面浏览', html: '{pieTitle|页面浏览}\n{li|审批浏览平均时长：' + val.UserViewAverage + 'min}\n{li|本部门排名：' + val.UserViewAverageSort + ' / ' + val.DepUserCount + '}' },
                        { value: 1, name: '附件审核', html: '{pieTitle|附件审核}\n{li|附件打开次数：' + val.AttachTimes + '次}\n{li|附件审核比例：' + val.AttachPercent + '%}\n{li|本部门排名：' + val.AttachTimesSort + ' / ' + val.DepUserCount + '}' },
                        { value: 1, name: '审批耗时', html: '{pieTitle|审批耗时}\n{li|审批总耗时：' + val.UserApproveTimeCount + 'h}\n{li|平均节点耗时：' + val.UserApproveTimeAverage + 'h}\n{li|本部门排名：' + val.UserApproveTimeSort + ' / ' + val.DepUserCount + '}' },
                        { value: 1, name: '严重超时', html: '{pieTitle|严重超时}\n{num|' + val.OverTimeTimes + '}\n{hr|}\n{li|即将超时流程：' + val.Pre_OverTimeTimes + '}' },
                        { value: 1, name: '审批及时率', html: '{pieTitle|审批及时率}\n{num|' + val.UserTimely + '%}\n{hr|}\n{li|总部部门负责人及以上}\n{li|人员及时率排名：' + val.ManagerCount + ' / ' + val.ManagerTimelySort + '}' }
                    ]
                } else {
                    data = [
                        { value: 1, name: '审批操作', html: '{pieTitle|审批操作}\n{li|已审批节点数：' + val.UserApproveTimes + '}\n{li|沟通次数：' + val.UserCommunicateTimes + '}\n{li|指派次数：' + val.UserRedirectTimes + '}' },
                        { value: 1, name: '页面浏览', html: '{pieTitle|页面浏览}\n{li|审批浏览平均时长：' + val.UserViewAverage + 'min}\n{li|本部门排名：' + val.UserViewAverageSort + ' / ' + val.DepUserCount + '}' },
                        { value: 1, name: '附件审核', html: '{pieTitle|附件审核}\n{li|附件打开次数：' + val.AttachTimes + '次}\n{li|附件审核比例：' + val.AttachPercent + '%}\n{li|本部门排名：' + val.AttachTimesSort + ' / ' + val.DepUserCount + '}' },
                        { value: 1, name: '审批耗时', html: '{pieTitle|审批耗时}\n{li|审批总耗时：' + val.UserApproveTimeCount + 'h}\n{li|平均节点耗时：' + val.UserApproveTimeAverage + 'h}\n{li|本部门排名：' + val.UserApproveTimeSort + ' / ' + val.DepUserCount + '}' },
                        { value: 1, name: '严重超时', html: '{pieTitle|严重超时}\n{num|' + val.OverTimeTimes + '}\n{hr|}\n{li|即将超时流程：' + val.Pre_OverTimeTimes + '}' },
                        { value: 1, name: '审批及时率', html: '{pieTitle|审批及时率}\n{num|' + val.UserTimely + '%}\n{hr|}\n{li|本部门排名：' + val.UserTimelySort + ' / ' + val.DepUserCount + '}' }
                    ]
                }





                var option = {
                    grid: {
                        top: 0,
                        left: 0,
                        right: 0,
                        bottom: 0
                    },
                    color: ['#70ad47', '#4472c4', '#ffc000', '#a5a5a5', '#ed7d31', '#5b9bd5'],
                    series: [
                        {
                            // name:'访问来源',
                            type: 'pie',
                            radius: ['45%', '65%'],
                            legendHoverLink: false,
                            hoverAnimation: false,
                            label: {
                                // formatter: '{a|{a}}{abg|}\n{hr|}\n  {b|{b}：}{c}  {per|{d}%}  ',
                                formatter: function (params) {
                                    return params.data.html
                                },
                                borderColor: '#d1d1d1',
                                borderWidth: 1,
                                borderRadius: 8,
                                padding: 10,
                                color: '#000',
                                // height: 100,
                                width: 150,
                                position: 'outer',
                                alignTo: 'labelLine',
                                rich: {
                                    pieTitle: {
                                        fontSize: 14,
                                        color: '#000',
                                        align: 'left',
                                        fontWeight: 700
                                    },
                                    li: {
                                        padding: [0, 0, 10, 0],
                                        color: '#383838',
                                        align: 'left'
                                    },
                                    hr: {
                                        borderColor: '#f3f3f3',
                                        width: 150,
                                        borderWidth: 0.5,
                                        height: 0
                                    },
                                    num: {
                                        align: 'center',
                                        color: '#ac1f24',
                                        fontSize: 26,
                                        padding: [10, 0, 10, 0]
                                    }
                                }
                            },
                            labelLine: {
                                normal: {
                                    length: 30,
                                    lineStyle: {
                                        color: '#ccc',
                                        width: 2,
                                        smooth: 1
                                    }
                                }
                            },
                            itemStyle: {
                                borderWidth: 8,
                                borderColor: '#fff'
                            },
                            data: data
                        }
                    ]
                }

                personalDetailsChart.setOption(option);
                $(".home-left #perChart").getNiceScroll().remove();
                var that = this
                this.$nextTick(function () {
                    that.personalDetailsChart.resize()
                    $(".home-left #perChart").niceScroll({ cursoropacitymin: 0.2, cursoropacitymax: 0.2, cursorcolor: "#000" });
                })
                // })
            },
            // 改变时间--本月，本季，全年
            changeMonth: function (val) {
                this.agingreportForm.curTime = val
                var time = this.getCurTime(val)
                this.agingreportForm.timerange = time
                // 请求接口
                this.resetChart({
                    companyId: this.agingreportForm.compName[0],
                    depId: this.agingreportForm.compName[1],
                    userStart: time[0],
                    userEnd: time[1]
                }, 1)
            },
            changeTime: function () {
                if (this.agingreportForm.timerange) {
                    this.agingreportForm.curTime = ''
                    // 请求接口
                    var form = {
                        companyId: this.agingreportForm.compName[0],
                        depId: this.agingreportForm.compName[1],
                        userStart: this.agingreportForm.timerange[0],
                        userEnd: this.agingreportForm.timerange[1]
                    }
                    this.resetChart(form, 1)
                }
            },
            // 改变部门
            handleChange: function () {
                var time = this.getCurTime('', this.agingreportForm.region)
                var form = {
                    companyId: this.agingreportForm.compName[0],
                    depId: this.agingreportForm.compName[1],
                    userStart: time[0],
                    userEnd: time[1],
                    orgStart: time[0],
                    orgEnd: time[1]
                }
                this.agingreportForm.curTime = ''
                // 改变部门需重新渲染图表
                this.companyApproveTimeListChart = null
                this.depApproveTimeListChart = null
                this.personalDetailsChart = null
                this.agingreportForm.timerange = [time[0], time[1]]
                this.resetChart(form)
                // 请求接口
            },

            getCurTime: function (type, val) {
                var startDate = ''
                var endDate = ''

                var currentQuarter = moment().quarter() // 当前是第几季度
                var currentYear = moment().year() // 当前年
                var endMonth = 3 * parseInt(currentQuarter) //当季度最后一个月
                /* 对月数进行格式化 */
                if (endMonth < 10)
                    endMonth = '0' + endMonth
                else
                    endMonth += ''

                switch (type) {
                    // 当月的开始结束日期
                    case 'month':
                        startDate = moment().month(moment().month()).startOf('month').format('YYYY-MM-DD')
                        endDate = moment().month(moment().month()).endOf('month').format('YYYY-MM-DD')
                        break;
                    case 'quarter':
                        startDate = moment(moment(currentYear + '-01-01').toDate()).quarter(currentQuarter).format('YYYY-MM-DD')
                        var endMonthDays = moment(currentYear + '-' + endMonth).daysInMonth(); // 末尾月天数
                        endDate = currentYear + '-' + endMonth + '-' + endMonthDays //完整年月日整合
                        break;
                    case 'year':
                        startDate = moment().year(moment().year()).startOf('year').format('YYYY-MM-DD')
                        endDate = moment().year(moment().year()).endOf('year').format('YYYY-MM-DD')
                        break;
                    default:
                        startDate = moment(val).startOf('month').format('YYYY-MM-DD')
                        endDate = moment(val).endOf('month').format('YYYY-MM-DD')
                }

                return [startDate, endDate]
            },
            // 改变月度
            handleChangeDate: function () {
                var time = this.getCurTime('', this.agingreportForm.region)
                // 请求接口
                this.resetChart({
                    companyId: this.agingreportForm.compName[0],
                    depId: this.agingreportForm.compName[1],
                    orgStart: time[0],
                    orgEnd: time[1]
                }, 2)
            },


            destroyed: function () {
                window.removeEventListener('resize', this.handleResetChar)
            }
        },
    })
</script>
<style>
    .el-dropdown-menu__item {
        width: 100px;
        box-sizing: border-box;
        text-align: center;
    }

        .el-dropdown-menu__item:focus, .el-dropdown-menu__item:not(.is-disabled):hover {
            color: #606266;
            background: #e7e8eb
        }
</style>
<link rel="stylesheet" href="~/Content/portal/DBH/Form/form.css">
<link rel="stylesheet" href="~/Content/portal/DBH/List/common.css">
