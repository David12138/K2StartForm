$(function(){"use strict";var i=0;var t={strokeWidth:2,stroke:"rgba(30, 83, 39, 1)",joinstyle:"round",outlineStroke:"transparent",outlineWidth:2},y={strokeWidth:2,stroke:"rgba(138, 201, 37, 1)",joinstyle:"round",outlineStroke:"transparent",outlineWidth:2},I={strokeWidth:2,stroke:"red",joinstyle:"round",outlineStroke:"transparent",outlineWidth:2},e={strokeWidth:3,stroke:"rgba(30, 83, 39, 1)",outlineWidth:5,outlineStroke:"transparent"},a={fill:"transparent",stroke:"transparent"},S={endpoint:"Dot",paintStyle:{stroke:"transparent",fill:"transparent",radius:7,strokeWidth:1},isSource:true,connector:["Straight"],connectorStyle:t,hoverPaintStyle:a,connectorHoverStyle:e,dragOptions:{},overlays:[["Label",{location:[.5,1.5],label:"Drag",cssClass:"endpointSourceLabel",visible:false}]]},P={endpoint:"Dot",paintStyle:{fill:"transparent",radius:7},hoverPaintStyle:a,maxConnections:-1,dropOptions:{hoverClass:"hover",activeClass:"active"},isTarget:true,overlays:[["Label",{location:[.5,-.5],label:"Drop",cssClass:"endpointTargetLabel",visible:false}]]},r=function(t){};var c=function(t,e,a,r,n){var s=$("#"+t);var i="Start"==a?$('<div class="item"><img src="/Images/start.png"/><span></span></div>'):$('<div class="item"><img src="/Images/DefaultActivity.png"/><span></span></div>');i.width(r.x).height(r.y).css("position","absolute").css("background-color","rgba(241, 241, 241, 1)").css("padding-top",r.y/4).css("top",n.y).css("left",n.x).attr("id",e);i.find("span").text(a);var o=i.find("img");o.height(r.y-10).width(r.y-10).css("float","left").css("position","relative").css("top",-8);s.append(i);return i};var N=function(t,e){if(e.Label==null||e.Label==""){return null}else{}var a=$("#"+t);var r=$('<span class="label">'+e.Label+"</span>");var n=A(e.Loc+",0,0");r.css("position","absolute").css("top",n[0].y+"px").css("left",n[0].x+"px").css("color","black").css("z-index",1);a.append(r);return n};var A=function(t){var e=t.split(",");var a=[];for(var r=0;r<e.length;r+=2){a.push({x:parseFloat(e[r]),y:parseFloat(e[r+1])+i})}return a};var d=function(t,e){var a=t.split(",");if(e=="true"){a[3]=parseInt(a[3])-22}else{}var r=[];for(var n=0;n<a.length;n+=2){if(n==0){r.push({x:parseFloat(a[n]),y:parseFloat(a[n+1])+i})}else{r.push({x:parseFloat(a[n]),y:parseFloat(a[n+1])})}}return r};var E=function(t,e){var a=e.Loc+","+e.Size;var r=e.StrOpn;var n=d(a,r);return[(t.x-n[0].x)/n[1].x,(t.y-n[0].y)/n[1].y,0,0]};var u=function(t,r){var n=null;var s=0;$.each(t.ViewProcess.ActInsts.ActInst,function(t,e){if(e.ActName==r){if(e.Status=="4"||e.Status=="2"||e.Status=="6"){var a=Number(e.ActInstID);if(isNaN(a)){n=e}else{if(s<Number(e.ActInstID)){s=Number(e.ActInstID);n=e}}}}});return n};var v=function(t,e){var a;if(e.Evt){if(e.Evt.length){for(var r=0;r<e.Evt.length;r++){var n=e.Evt[r];for(var s=0;s<t.ViewProcess.EventInsts.EventInst.length;s++){var i=t.ViewProcess.EventInsts.EventInst[s];if(i.ActName==e.Name&&i.EventName==n.Name){if(i.Status=="4"){a=i.Status;break}}}}}else{if(t.ViewProcess.EventInsts.EventInst.length){for(var s=0;s<t.ViewProcess.EventInsts.EventInst.length;s++){var i=t.ViewProcess.EventInsts.EventInst[s];if(i.ActName==e.Name&&i.EventName==e.Evt.Name){if(i.Status=="4"){a=i.Status;break}}}}else{var i=t.ViewProcess.EventInsts.EventInst;if(i.ActName==e.Name&&i.EventName==e.Evt.Name){if(i.Status=="4"){a=i.Status}}}}}if(a=="4"){return 6}return undefined};var L=function(t,a){var r=null;if(t.ViewProcess.LineInsts.LineInst.length){$.each(t.ViewProcess.LineInsts.LineInst,function(t,e){if(e.LineName==a){r=e;return false}})}else{var e=t.ViewProcess.LineInsts.LineInst;if(e.LineName==a){r=e}}return r};var k=function(a){var r=null;$.each(V.ViewProcess.Process.Acts.Act,function(t,e){if(e.Name==a){r=e;return false}});return r};var n=function(t){if(t==1){return"Waiting"}if(t==2){return"Active"}if(t==3){return"Expired"}if(t==4){return"Completed"}if(t==6){return"Error"}};var f=function(t,r){$.each(t,function(t,e){var a=new RegExp("\\["+t+"\\]","g");if(t=="Status"){r=r.replace(a,n(e))}else{r=r.replace(a,e)}});return r};var p={Loading:function(){if($(".modal-backdrop.onloading").length==0){$('<div class="modal-backdrop fade in onloading"/>').appendTo("body")}},Loaded:function(){$(".modal-backdrop.onloading").remove()}};var s=function(t){return t.replace(/\\/g,"//")};var V=JSON.parse(s(jsonString));var r=function(){var t="";var e;if(!V.Error){t=" ViewFlow - "+V.ViewProcess.Process.Name+"("+V.ViewProcess.ProcessInstance.Folio+")";$("title").text(V.ViewProcess.ProcessInstance.Folio);$(".flowTitle").text(t);try{var a=k("Start");var r=a.Loc+","+a.Size;var n=a.StrOpn;var s=d(r,n);if(s[0].y<=32){i=32}else{i=42-s[0].y}}catch(t){throw t}}else{if(V.ViewProcess.Process.Folder=="KStar"){t="流程异常，请联系管理员修复流程。";V.Info=V.Error;$("title").text(t);if(V.Info){e="</br><a style='margin-left: 60px;' href='#' onclick=\"alert('"+V.Info+"')\">点击查看更多信息</a>"}$(".flowTitle").text(t).css("color","red");$(".flowTitle").append(e)}else{t=V.Error;$("title").text(t);if(V.Info){e="</br><a style='margin-left: 60px;' href='#' onclick=\"alert('"+V.Info+"')\">点击查看更多信息</a>"}$(".flowTitle").text(t).css("color","red");$(".flowTitle").append(e)}}};r();jsPlumb.ready(function(){var b="demo";var w=window.jsp=jsPlumb.getInstance({DragOptions:{cursor:"pointer",zIndex:2e3},ConnectionOverlays:[["Arrow",{location:1,visible:true,width:1,length:11,id:"ARROW",events:{click:function(){}}}],["Label",{location:.1,id:"label",cssClass:"aLabel",events:{tap:function(){}}}]],Container:b});var t={connector:"Flowchart",paintStyle:{stroke:"red",strokeWidth:4},hoverPaintStyle:{stroke:"blue"},overlays:["Arrow"]};w.registerConnectionType("basic",t);$.each(V.ViewProcess.Process.Acts.Act,function(t,e){var a=e.Loc+","+e.Size;var r=e.StrOpn;var n=d(a,r);var s=e.Name;if(s=="Start"){n[1].y=n[1].y+8}var i=c(b,s,e.Name,n[1],n[0]);var o=u(V,s);if(s!="Start"){var l=v(V,e);if(l){o.Status=l}}if(o!=null){if(o.Status==2){i.css("background-color","rgba(196, 216, 235, 1)")}else if(o.Status==6){i.css("background-color","rgba(196, 216, 235, 1)");i.css("border","2px solid red");i.append('<img src="/images/error_vf.png" style="height: 16px; width: 16px; float: right; position: relative; top: -12px;">')}else{i.css("background-color","rgba(213, 238, 175, 1)")}}$(i).data("ActInst",o);$(i).data("Act",e)});$.each(V.ViewProcess.Process.Lines.Line,function(t,e){var r=e.Start;var a=e.End;var n=k(r);var s=k(a);var i=e.Anchor;var o=e.Name+r;var l=e.Name+a;var c=e.Label;var d=i.Coords.replace(/\+/g,",");var u=d.split(",");var v=u.join(",");var f=A(v);var p=E(f[0],n);var h=E(f[f.length-1],s);var m=L(V,e.Name);var g=JSON.parse(JSON.stringify(S));if(m!=null){if(m.Result==2){g.connectorStyle=I}else{g.connectorStyle=y}}N(b,c);w.addEndpoint(r,{anchor:p,uuid:o},g);if(f.length>2){$.each(f,function(t,e){if(t!=0&&t!=f.length-1){var a=E(e,n);w.addEndpoint(r,{anchor:a,uuid:o+t},P);w.addEndpoint(r,{anchor:a,uuid:t+o+t},g)}})}w.addEndpoint(a,{anchor:h,uuid:l},P);if(f.length==2){w.connect({uuids:[o,l],editable:false,overlays:[["Arrow",{location:1,visible:true,width:11,length:11,id:"arrow2"}]]})}else{$.each(f,function(t,e){if(t==0){w.connect({uuids:[o,o+1],editable:false})}else if(t>0&&t<f.length-2){w.connect({uuids:[t+o+t,o+(t+1)],editable:false})}else if(t==f.length-2){w.connect({uuids:[t+o+t,l],editable:false,overlays:[["Arrow",{location:1,visible:true,width:11,length:11,id:"arrow2"}]]})}})}});w.bind("connection",function(t,e){r(t.connection)});jsPlumb.fire("jsPlumbdemoLoaded",w);$("#"+b).delegate(".item","click",function(t){var e=t.currentTarget;var o=$(e).data("ActInst");var l=$(e).data("Act");if(o==null){var a=$("#prognosisTemplate").html().trim();a=f(l,a);var s=$(a);s.modal("show").on("hidden.bs.modal",function(t){$(a).remove();$(".modal").remove()});s.find(".modal-body li a").on("show.bs.tab",function(t){var e=$(t.target);var a=e.attr("aria-controls");if(a=="Overview"){return true}if(e.data("request")==true){return true}if(a=="Participants"){e.data("request",true);var r=s.find("#participants");var n=r.find("tbody");p.Loading();$.post("/ViewFlow/GetActivityParticipants",{FormId:V.ViewProcess.ProcessInstance.FormId,ActName:l.Name},function(t){p.Loaded();e.data("request",true);if(t.length==0){e.tab("show");return}$.each(t,function(t,e){var a="<tr><td>"+e.UserDisplayName+"</td><td>"+e.StatusName+"</td></tr>";n.append($(a))});e.tab("show")})}return false});return}var r=$("#detailsTemplate").html().trim();r=f(o,r);var c=$(r);c.modal("show").on("hidden.bs.modal",function(t){$(r).remove();$(".modal").remove()});c.find(".modal-body li a").on("show.bs.tab",function(t){var n=$(t.target);var e=n.attr("aria-controls");if(e=="Overview"){return true}if(n.data("request")==true){return true}if(e=="Participants"){n.data("request",true);var a=c.find("#participants");var r=a.find("tbody");p.Loading();$.post("/ViewFlow/GetActivityInstanceParticipants",{FormId:V.ViewProcess.ProcessInstance.FormId,ActName:l.Name,ActStatus:o.Status},function(t){p.Loaded();n.data("request",true);if(t.length==0){n.tab("show");return}$.each(t,function(t,e){var a="<tr><td>"+e.UserDisplayName+"</td><td>"+e.StartDate+"</td>"+"<td>"+e.EndDate+"</td><td>"+e.StatusName+"</td>"+"<td>"+e.ActionName+"</td></tr>";r.append($(a))});n.tab("show")})}if(e=="Activity Data"){var s=c.find("#activityData");var i=s.find("tbody");p.Loading();$.post("/ViewFlow/GetActivityInstanceData",{ProcessID:V.ViewProcess.ProcessInstance.ProcInstID,ActInstID:o.ActInstID},function(t,e,a){p.Loaded();n.data("request",true);if(!t){n.tab("show");return}var r=JSON.parse(t);if(r.ActivityInstanceData.DataFields==null){n.tab("show");return}$.each(r.ActivityInstanceData.DataFields.DataField,function(t,e){var a="<tr><td>"+e.Name+"</td>"+"<td>"+e.Value+"</td>";if(e.AuditValues){a+="<td>"+e.AuditValues.Value.DateChanged+"</td>"+"<td>"+e.AuditValues.Value.ChangedBy+"</td></tr>"}else{a+="<td></td><td></td></tr>"}i.append($(a))});n.tab("show")},"json")}return false})})})});